<script>
{
  const FALLBACK_IMAGE = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEElEQVR42gEFAPr/AP///wAI/AL+Sr4t6gAAAABJRU5ErkJggg==';

  class LazyloadImage extends HTMLImageElement {
    constructor() {
      super();
    }

    createdCallback() {
      this.original = this.currentSrc || this.src;
      this.src = FALLBACK_IMAGE;
      this.observer = new IntersectionObserver(this.visibleChanged.bind(this));
    }

    attachedCallback() {
      this.observer.observe(this);
    }

    detachedCallback() {
      this.observer.unobserve(this);
    }

    visibleChanged(changes) {
      for (let change of changes) {
        let intersectionRect = change.intersectionRect;
        if (intersectionRect.height * intersectionRect.width > 0) {
          this.addEventListener('load', () => {
            this.observer.unobserve(this);
          });
          this.addEventListener('error', () => {
            this.removeAttribute('srcset');
            this.src = FALLBACK_IMAGE;
            this.observer.unobserve(this);
          });
          this.src = this.original;
        }
      }
    }
  }

  window.customElements.define('lazyload-image', LazyloadImage, {
    extends : 'img'
  });

  window.LazyloadImage = LazyloadImage;
}
</script>
